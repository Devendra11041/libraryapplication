sap.ui.define(["./Basecontroller","sap/m/Token","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/Fragment","sap/m/MessageBox","sap/m/MessageToast","sap/ui/model/odata/v2/ODataModel"],function(e,t,o,s,i,r,n,a){"use strict";return e.extend("com.app.centrallibrary.controller.Allbooks",{onInit:function(){const e=this.getView().byId("iduserBookTable");e.attachBrowserEvent("dblclick",this.onRowDoubleClick.bind(this));const o=this.getOwnerComponent().getRouter();o.attachRoutePatternMatched(this.onUserDetailsLoad,this);const s=this.getView();const i=s.byId("iduserTitleFilterValue");const r=s.byId("iduserAuthorFilterValue");const n=s.byId("iduserGenreFilterValue");const a=s.byId("iduserISBNFilterValue");let l=function(e){if(true){var o=e.text;return new t({key:o,text:o})}};i.addValidator(l);r.addValidator(l);n.addValidator(l);a.addValidator(l)},onUserDetailsLoad:function(e){const{id:t}=e.getParameter("arguments");this.ID=t;const o=this.getView().byId("iduserpage");o.bindElement(`/User(${t})`)},onGoPress:function(){const e=this.getView(),t=e.byId("iduserTitleFilterValue"),i=e.byId("iduserAuthorFilterValue"),r=e.byId("iduserGenreFilterValue"),n=e.byId("iduserISBNFilterValue"),a=t.getTokens(),l=i.getTokens(),d=r.getTokens(),u=n.getTokens(),c=e.byId("iduserBookTable"),g=[];a.filter(e=>{e?g.push(new o("title",s.EQ,e.getKey())):""});l.filter(e=>{e?g.push(new o("Author",s.EQ,e.getKey())):""});d.filter(e=>{e?g.push(new o("genre",s.EQ,e.getKey())):""});u.filter(e=>{e?g.push(new o("ISBN",s.EQ,e.getKey())):""});c.getBinding("items").filter(g)},onClearPress:function(){const e=this.getView(),t=e.byId("iduserTitleFilterValue").destroyTokens(),o=e.byId("iduserAuthorFilterValue").destroyTokens(),s=e.byId("iduserGenreFilterValue").destroyTokens(),i=e.byId("iduserISBNFilterValue").destroyTokens()},onpageclose:function(){window.history.back()},onReserrveBtnPress:async function(e){debugger;var t=e.getSource().getParent();var o=t.getBindingContext().getObject();var s=this.byId("iduserBookTable").getSelectedItem().getBindingContext().getObject();var i=this.getView().getModel("ModelV2");if(!s){n.show("Please select a Book");return}r.confirm("Are you sure you want to reserve this book?",{title:"Confirm Reservation",onClose:async function(e){if(e===r.Action.OK){if(this.byId("iduserBookTable").getSelectedItems().length>1){n.show("Please Select only one Book");return}if(s.availability===0){n.show("Book is not available");return}var t=s.availability-1;const e=await this.bookInactiveLoans(s.ID,this.ID);if(e){n.show("You have an active loan for the selected book.");return}const o=await this.checkIfBookIsReservedByUser(s.ID,this.ID);if(o){r.error("This book is already reserved by you.");return}const a=new sap.ui.model.json.JSONModel({user_ID:this.ID,book_ID:s.ID,reservedDate:new Date,book:{availability:t}});this.getView().setModel(a,"userModel");const l=this.getView().getModel("userModel").getProperty("/");try{await this.createData(i,l,"/IssueBook");i.refresh();sap.m.MessageBox.success(`${s.title} Book Reserved`);this.getView().byId("iduserBookTable").getBinding("items").refresh()}catch(e){r.error("Some technical issue occurred.")}}else{n.show("Reservation canceled.")}}.bind(this)})},checkIfBookIsReservedByUser:function(e,t){return new Promise((i,r)=>{const n=this.getView().getModel("ModelV2");const a=[new o("book_ID",s.EQ,e),new o("user_ID",s.EQ,t)];n.read("/IssueBook",{filters:a,success:function(e){i(e.results.length>0)},error:function(e){r(e)}})})},bookInactiveLoans:function(e,t){return new Promise((i,r)=>{const n=this.getView().getModel("ModelV2");const a=[new o("books_ID",s.EQ,e),new o("users_ID",s.EQ,t)];n.read("/ActiveLoans",{filters:a,success:function(e){const t=e.results.some(e=>!e.returndate);i(t)},error:function(e){r(e)}})})},onRowDoubleClick:function(){var e=this.byId("iduserBookTable").getSelectedItem();var t=e.getBindingContext().getObject().ID;const o=this.getOwnerComponent().getRouter();o.navTo("RouteBookData",{BookId:t})}})});
//# sourceMappingURL=Allbooks.controller.js.map