sap.ui.define(["./Basecontroller","sap/m/Token","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ui/core/Fragment","sap/m/MessageBox","sap/ui/model/odata/v2/ODataModel","sap/m/MessageToast"],function(e,t,o,i,s,n,a,r,l){"use strict";return e.extend("com.app.centrallibrary.controller.Admin",{onInit:function(){this.oQuantity=null;this.oAq=null;const e=this.getView();const o=e.byId("idTitleFilterValue");const i=e.byId("idAuthorFilterValue");const n=e.byId("idGenreFilterValue");const a=e.byId("idISBNFilterValue");let r=function(e){if(true){var o=e.text;return new t({key:o,text:o})}};o.addValidator(r);i.addValidator(r);n.addValidator(r);a.addValidator(r);const l=new s({ID:"",title:"",Author:"",ISBN:"",Price:"",genre:"",Language:"",total_books:"",availability:""});this.getView().setModel(l,"localModel");const d=this.getView().byId("idBookTable");d.attachBrowserEvent("dblclick",this.onRowDoubleClick.bind(this))},onGoPress:function(){const e=this.getView(),t=e.byId("idTitleFilterValue"),s=e.byId("idAuthorFilterValue"),n=e.byId("idGenreFilterValue"),a=e.byId("idISBNFilterValue"),r=t.getTokens(),l=s.getTokens(),d=n.getTokens(),c=a.getTokens(),u=e.byId("idBookTable"),g=[];r.filter(e=>{e?g.push(new o("title",i.EQ,e.getKey())):""});l.filter(e=>{e?g.push(new o("Author",i.EQ,e.getKey())):""});d.filter(e=>{e?g.push(new o("genre",i.EQ,e.getKey())):""});c.filter(e=>{e?g.push(new o("ISBN",i.EQ,e.getKey())):""});u.getBinding("items").filter(g)},onClearPress:function(){const e=this.getView();if(!e){return}const t=["idTitleFilterValue","idAuthorFilterValue","idGenreFilterValue","idISBNFilterValue"];t.forEach(t=>{const o=e.byId(t);if(o){o.removeAllTokens()}else{console.error(`Filter control with ID ${t} not found.`)}})},onCreateBtnPress:async function(){if(!this.ocreate){this.ocreate=await n.load({id:this.getView().getId(),name:"com.app.centrallibrary.fragments.create",controller:this});this.getView().addDependent(this.ocreate)}this.ocreate.open()},onCloseBook:function(){if(this.ocreate.isOpen()){this.ocreate.close()}},onCreateBook:async function(){debugger;const e=this.getView().getModel("localModel").getProperty("/");const t=Object.values(e).some(e=>e==="");if(t){a.error("Please fill in all fields.");return}const o=this.getView().getModel("ModelV2");try{debugger;await this.createData(o,e,"/Book");this.getView().byId("idBookTable").getBinding("items").refresh();this.ocreate.close();a.success(`${e.title} book added successfully`)}catch(e){this.ocreate.close();a.error("Some technical Issue")}},onDeleteButtonPress:async function(){var e=this;var t=this.byId("idBookTable").getSelectedItems();if(t.length>0){a.confirm("Are you sure you want to delete the selected book(s)?",{title:"Confirm Deletion",onClose:function(o){if(o===a.Action.OK){var i=[];t.forEach(function(e){var t=e.getBindingContext().getObject().title;var o=e.getBindingContext().getObject().total_books;var s=e.getBindingContext().getObject().availability;if(o==s){i.push(t);e.getBindingContext().delete("$auto")}else{a.error("Cannot delete the book. It has ActiveLoans.");return}});Promise.all(i.map(function(e){return new Promise(function(t,o){t(e+" Successfully Deleted")})})).then(function(e){e.forEach(function(e){a.success(e)})}).catch(function(e){a.error("Deletion Error: "+e)});e.getView().byId("idBookTable").removeSelections(true);e.getView().byId("idBookTable").getBinding("items").refresh()}}});jQuery(".sapMMessageBoxText").css("color","red")}else{a.error("Please Select Rows to Delete")}},onclosepage:function(){var e=this.getOwnerComponent().getRouter();e.navTo("RouteHome1",{},true)},onRowDoubleClick:function(){var e=this.byId("idBookTable").getSelectedItem();var t=e.getBindingContext().getObject().ID;const o=this.getOwnerComponent().getRouter();o.navTo("RouteBookData",{BookId:t})},onGoPreseeActive:async function(){const e=this.getOwnerComponent().getRouter();e.navTo("RouteActiveLoans")},onCancelPress:function(){if(this.oedit.isOpen()){this.oedit.close()}},onEditPress:async function(){var e=this.byId("idBookTable").getSelectedItems();if(e.length===0){a.error("Please Select atleast one Book to Edit");return}var t=e[0];if(t){var o=t.getBindingContext().getProperty("Author");var i=t.getBindingContext().getProperty("genre");var s=t.getBindingContext().getProperty("Language");var n=t.getBindingContext().getProperty("Price");this.oQuantity=t.getBindingContext().getProperty("total_books");var r=t.getBindingContext().getProperty("ISBN");var l=t.getBindingContext().getProperty("title");var d=t.getBindingContext().getProperty("ID");this.oAq=t.getBindingContext().getProperty("availability");var c=new sap.ui.model.json.JSONModel({ID:d,Author:o,genre:i,Language:s,Price:n,total_books:this.oQuantity,ISBN:r,title:l,availability:this.oAq});this.getView().setModel(c,"newBookModel");if(!this.oedit){this.oedit=await this.loadFragment("edit")}this.oedit.open();var u=this.getView().getModel("newBookModel").getData();console.log(u)}},onSavePress:function(){console.log(this.oQuantity);console.log(this.oAq);var e=parseInt(this.getView().byId("totalbookInput").getValue());var t=parseInt(this.getView().byId("availabilitynput").getValue());if(this.oQuantity<e){e=e-this.oQuantity;t=t+e}else if(this.oQuantity>e){e=this.oQuantity-e;t=t-e}else{t=t}console.log(e);var o=this.getView().getModel("newBookModel").getData();o.availability=t;this.getView().getModel("newBookModel").setData(o);var i=this.getOwnerComponent().getModel("ModelV2");console.log(i.getMetadata().getName());try{i.update("/Book("+o.ID+")",o,{success:function(){this.getView().byId("idBookTable").getBinding("items").refresh();this.oedit.close();a.success("Book Data Updated successfully")}.bind(this),error:function(e){this.oedit.close();sap.m.MessageBox.error("Failed to update book: "+e.message)}.bind(this)})}catch(e){this.oedit.close();sap.m.MessageBox.error("Some technical Issue")}var i=new sap.ui.model.odata.v2.ODataModel({serviceUrl:"https://port4004-workspaces-ws-rntqs.us10.trial.applicationstudio.cloud.sap/v2/CentralLibrary",defaultBindingMode:sap.ui.model.BindingMode.TwoWay,messageParser:sap.ui.model.odata.ODataMessageParser})},onIssueBook:async function(){if(!this.oissuebook){this.oissuebook=await this.loadFragment("issuebook")}this.oissuebook.open()},onissuebookscancelbtn:function(){if(this.oissuebook.isOpen()){this.oissuebook.close()}},onReservebtnpress:async function(e){if(this.byId("issuebooksTable").getSelectedItems().length>1){l.show("Please Select only one Book");return}var t=this.byId("issuebooksTable").getSelectedItem().getBindingContext().getObject(),o=t.book.availability-1;var i=new Date;let s=new Date(i.getFullYear(),i.getMonth()+1);const n=new sap.ui.model.json.JSONModel({books_ID:t.book.ID,users_ID:t.user.ID,issuseDate:new Date,DueDate:s,notify:`Your reserved book "\n                ${t.book.title}\n                " is issued`,books:{availability:o}});this.getView().setModel(n,"userModel");const a=this.getView().getModel("userModel").getProperty("/"),r=this.getView().getModel("ModelV2");try{await this.createData(r,a,"/ActiveLoans");debugger;sap.m.MessageBox.success(t.book.title+" Book Issued successfully");this.byId("issuebooksTable").getSelectedItem().getBindingContext().delete("$auto");r.update("/Book("+t.book.ID+")",a.books,{success:function(){},error:function(e){sap.m.MessageBox.error("Failed to update book: "+e.message)}.bind(this)})}catch(e){sap.m.MessageBox.error("Some technical Issue")}},onpressusers:async function(){const e=this.getOwnerComponent().getRouter();e.navTo("Routeallusers")}})});
//# sourceMappingURL=Admin.controller.js.map